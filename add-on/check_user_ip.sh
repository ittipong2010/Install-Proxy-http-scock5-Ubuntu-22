#!/bin/bash

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ User ‡∏°‡∏≤‡πÑ‡∏´‡∏°
if [ -z "$1" ]; then
    echo "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ User (‡πÄ‡∏ä‡πà‡∏ô ./check_user_ip.sh lkproxy3 http)"
    exit 1
fi

TARGET_USER="$1"
FILTER_TYPE="$2"  # <--- ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏ä‡πà‡∏ô http ‡∏´‡∏£‡∏∑‡∏≠ sock5)
CONFIG_FILE="/etc/3proxy/3proxy.cfg"
PASS_FILE="/etc/3proxy/passwd"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å‡∏ó‡∏µ‡πà $CONFIG_FILE"
    exit 1
fi

# echo "================================================"
# echo " üîé ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ($TARGET_USER)"
# echo "================================================"

# -----------------------------------------------------------
# 1. ‡∏´‡∏≤ Password
# -----------------------------------------------------------
if [ -f "$PASS_FILE" ]; then
    # ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå passwd (‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 3)
    USER_PASS=$(grep "^$TARGET_USER:CL:" "$PASS_FILE" | awk -F: '{print $3}')
else
    # ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå cfg
    USER_PASS=$(grep "users $TARGET_USER:CL:" "$CONFIG_FILE" | awk -F: '{print $4}')
fi

# ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ User ‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠ Pass ‡πÑ‡∏°‡πà‡∏°‡∏µ)
if [ -z "$USER_PASS" ]; then
    USER_PASS="CHECK_PASS_FILE"
fi

# -----------------------------------------------------------
# 2. ‡∏î‡∏∂‡∏á IP/Port ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (HTTP/SOCKS)
# -----------------------------------------------------------

awk -v target="$TARGET_USER" -v pass="$USER_PASS" -v ftype="$FILTER_TYPE" '
BEGIN {
    active = 0;
}
{
    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î allow
    if ($1 == "allow") {
        if ($2 == target) {
            active = 1; # ‡πÄ‡∏à‡∏≠ User ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ -> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡πá‡∏ö
        } else {
            active = 0; # ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà -> ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡πá‡∏ö
        }
    }
    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î flush -> ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡πá‡∏ö
    else if ($1 == "flush") {
        active = 0;
    }
    # ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô Active ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î proxy ‡∏´‡∏£‡∏∑‡∏≠ socks
    else if (active == 1 && ($1 == "proxy" || $1 == "socks")) {
        
        current_type = $1; # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô proxy ‡∏´‡∏£‡∏∑‡∏≠ socks
        show_line = 0;     # ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÑ‡∏´‡∏°

        # --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á ---
        if (ftype == "") { 
            show_line = 1; # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ -> ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏°‡∏î
        } 
        else if (ftype == "http" && current_type == "proxy") { 
            show_line = 1; # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å http -> ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà proxy
        }
        else if ((ftype == "sock5" || ftype == "socks") && current_type == "socks") { 
            show_line = 1; # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å sock5 -> ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà socks
        }

        # ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á IP/Port
        if (show_line == 1) {
            line = $0;
            
            # ‡∏î‡∏∂‡∏á Port (‡∏´‡∏•‡∏±‡∏á -p)
            match(line, /-p[0-9]+/);
            if (RSTART > 0) {
                port = substr(line, RSTART+2, RLENGTH-2);
            }

            # ‡∏î‡∏∂‡∏á IP (‡∏´‡∏•‡∏±‡∏á -e)
            match(line, /-e[0-9.]+/);
            if (RSTART > 0) {
                ip = substr(line, RSTART+2, RLENGTH-2);
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                print ip ":" port ":" target ":" pass;
            }
        }
    }
}
' "$CONFIG_FILE" > /tmp/user_ip_list.txt

# -----------------------------------------------------------
# ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
# -----------------------------------------------------------
if [ ! -s /tmp/user_ip_list.txt ]; then
    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå filter ‡∏ú‡∏¥‡∏î)
    echo "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" 
    # (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏∞ User ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏¥‡∏î ‡πÄ‡∏ä‡πà‡∏ô User ‡∏°‡∏µ‡πÅ‡∏ï‡πà SOCKS ‡πÅ‡∏ï‡πà‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡∏´‡∏≤ HTTP)
else
    cat /tmp/user_ip_list.txt
fi

# ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
rm -f /tmp/user_ip_list.txt