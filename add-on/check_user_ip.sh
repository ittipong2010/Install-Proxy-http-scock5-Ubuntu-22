#!/bin/bash

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ User ‡∏°‡∏≤‡πÑ‡∏´‡∏°
if [ -z "$1" ]; then
    echo "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ User (‡πÄ‡∏ä‡πà‡∏ô ./check_user_ip.sh lkproxy3)"
    exit 1
fi

TARGET_USER="$1"
CONFIG_FILE="/etc/3proxy/3proxy.cfg"
PASS_FILE="/etc/3proxy/passwd"  # <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå Password ‡πÅ‡∏¢‡∏Å

if [ ! -f "$CONFIG_FILE" ]; then
    echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å‡∏ó‡∏µ‡πà $CONFIG_FILE"
    exit 1
fi

echo "================================================"
echo " üîé ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ($TARGET_USER)"
echo "================================================"

# -----------------------------------------------------------
# 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏´‡∏≤ Password: ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå passwd ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
# -----------------------------------------------------------
# ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå passwd ‡πÑ‡∏´‡∏°
if [ -f "$PASS_FILE" ]; then
    # ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå passwd (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö user:CL:pass)
    # ‡πÉ‡∏ä‡πâ grep ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ user:CL: ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 3
    USER_PASS=$(grep "^$TARGET_USER:CL:" "$PASS_FILE" | awk -F: '{print $3}')
else
    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå passwd ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÉ‡∏ô cfg ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
    USER_PASS=$(grep "users $TARGET_USER:CL:" "$CONFIG_FILE" | awk -F: '{print $4}')
fi

# ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
if [ -z "$USER_PASS" ]; then
    USER_PASS="CHECK_PASS_FILE"
fi

# -----------------------------------------------------------
# 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á IP/Port: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ "socks" ‡∏î‡πâ‡∏ß‡∏¢
# -----------------------------------------------------------

awk -v target="$TARGET_USER" -v pass="$USER_PASS" '
BEGIN {
    active = 0;
}
{
    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î allow
    if ($1 == "allow") {
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô user ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏°
        if ($2 == target) {
            active = 1; # ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        } else {
            active = 0; # ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î (‡πÄ‡∏õ‡πá‡∏ô user ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
        }
    }
    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î flush (‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤) ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡πá‡∏ö
    else if ($1 == "flush") {
        active = 0;
    }
    # ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î active ‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î proxy ‡∏´‡∏£‡∏∑‡∏≠ socks (‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°)
    else if (active == 1 && ($1 == "proxy" || $1 == "socks")) {
        
        line = $0;
        
        # ‡∏î‡∏∂‡∏á Port (‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏á -p)
        match(line, /-p[0-9]+/);
        if (RSTART > 0) {
            port = substr(line, RSTART+2, RLENGTH-2);
        }

        # ‡∏î‡∏∂‡∏á IP (‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏á -e)
        match(line, /-e[0-9.]+/);
        if (RSTART > 0) {
            ip = substr(line, RSTART+2, RLENGTH-2);
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå IP:PORT:USER:PASS
            print ip ":" port ":" target ":" pass;
        }
    }
}
' "$CONFIG_FILE" > /tmp/user_ip_list.txt

# -----------------------------------------------------------
# ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
# -----------------------------------------------------------
if [ ! -s /tmp/user_ip_list.txt ]; then
    echo "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ User ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå Config)"
    COUNT=0
else
    cat /tmp/user_ip_list.txt
    COUNT=$(wc -l < /tmp/user_ip_list.txt)
fi

rm -f /tmp/user_ip_list.txt

echo "================================================"
echo "‚úÖ ‡∏™‡∏£‡∏∏‡∏õ: ‡∏û‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î $COUNT ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
echo "================================================"